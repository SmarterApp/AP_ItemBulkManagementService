package org.opentestsystem.ap.ibms;

import lombok.extern.slf4j.Slf4j;
import org.opentestsystem.ap.common.bulkupdate.ItemBulkUpdateEventProducer;
import org.opentestsystem.ap.common.bulkupdate.ItemBulkUpdateFactory;
import org.opentestsystem.ap.common.bulkupdate.ItemBulkUpdateFileManager;
import org.opentestsystem.ap.common.bulkupdate.ItemBulkUpdateItemManager;
import org.opentestsystem.ap.common.bulkupdate.ItemBulkUpdateUtility;
import org.opentestsystem.ap.common.bulkupdate.model.ItemBulkUpdate;
import org.opentestsystem.ap.common.config.ItemBankProperties;
import org.opentestsystem.ap.common.datastore.entity.ItemBulkUpdateEntity;
import org.opentestsystem.ap.common.datastore.repository.ItemBulkUpdateEntityRepository;
import org.opentestsystem.ap.common.datastore.repository.SequenceRepository;
import org.opentestsystem.ap.common.util.SecurityUtil;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.web.multipart.MultipartFile;

import java.sql.Date;
import java.time.Instant;
import java.util.List;

import static org.opentestsystem.ap.common.bulkupdate.ItemBulkUpdateConstants.IBU_STATUS_PENDING;
import static org.opentestsystem.ap.common.bulkupdate.ItemBulkUpdateConstants.IBU_STATUS_RECEIVED;
import static org.opentestsystem.ap.common.model.ItemConstants.Section.SECTION_ASL;

@Slf4j
@Service
public class ItemBulkUpdateService {

    private final ItemBankProperties itemBankProperties;

    private final SequenceRepository seqMgr;

    private final ItemBulkUpdateEntityRepository entityMgr;

    private final SecurityUtil securityUtil;

    private final ItemBulkUpdateFactory factory;

    private final ItemBulkUpdateFileManager fileMgr;

    private final ItemBulkUpdateUtility utility;

    private final ItemBulkUpdateEventProducer eventProducer;

    private final ItemBulkUpdateItemManager itemMgr;

    public ItemBulkUpdateService(ItemBankProperties itemBankProperties,
                                 SequenceRepository seqMgr,
                                 ItemBulkUpdateEntityRepository entityMgr,
                                 SecurityUtil securityUtil,
                                 ItemBulkUpdateFactory factory,
                                 ItemBulkUpdateFileManager fileMgr,
                                 ItemBulkUpdateUtility utility,
                                 ItemBulkUpdateEventProducer eventProducer,
                                 ItemBulkUpdateItemManager itemMgr) {
        this.itemBankProperties = itemBankProperties;
        this.seqMgr = seqMgr;
        this.entityMgr = entityMgr;
        this.securityUtil = securityUtil;
        this.factory = factory;
        this.fileMgr = fileMgr;
        this.utility = utility;
        this.eventProducer = eventProducer;
        this.itemMgr = itemMgr;
    }

    public List<String> findItemsWithActiveBranch(String... itemIds) {
        return this.itemMgr.findItemsWithActiveBranch(SECTION_ASL, itemIds);
    }

    @Transactional
    public ItemBulkUpdate processUpdateRequest(IbmsUpdateRequest request) {
        log.info("processing the request");

        ItemBulkUpdate ibu = this.processReceived(request, securityUtil.getUsername());

        log.info("the request contains file {}", ibu.getUploadFileName());
        this.fileMgr.uploadItemBulkUpdateFile(ibu.getUpdateId(), request.getFile());

        ItemBulkUpdate ibuClone = this.processPending(ibu);

        return ibuClone;
    }

    private ItemBulkUpdate processReceived(IbmsUpdateRequest request, String startedBy) {
        log.info("processReceived");
        String updateId = seqMgr.nextItemBulkUpdateSequence().toString();

        String updateType = request.getUpdateType();
        MultipartFile file = request.getFile();

        ItemBulkUpdate ibu = factory.newModel(updateId, updateType);
        ibu.timestamp();

        ibu.setUpdateStatus(IBU_STATUS_RECEIVED);
        ibu.setUpdateOwner(startedBy);
        ibu.setUpdateStartDate(Date.from(Instant.now()));

        ibu.setUploadFileName(file.getOriginalFilename());
        ibu.setUploadFileSize(String.valueOf(file.getSize()));

        this.save(ibu);

        return ibu;
    }

    private ItemBulkUpdate processPending(ItemBulkUpdate ibu) {
        log.info("processPending");

        ItemBulkUpdate ibuClone = this.utility.cloneModel(ibu);
        ibuClone.timestamp();
        ibuClone.setUpdateStatus(IBU_STATUS_PENDING);
        ibuClone.setUploadCompleteDate(Date.from(Instant.now()));
        ibuClone.setUploadDuration(Long.toString(
                ibuClone.getUploadCompleteDate().getTime() - ibuClone.getUpdateStartDate().getTime()));

        ItemBulkUpdateEntity entity = this.save(ibuClone);

        this.eventProducer.sendPendingRequestEvent(entity);

        return ibuClone;
    }

    private ItemBulkUpdateEntity save(ItemBulkUpdate model) {
        ItemBulkUpdateEntity entity = new ItemBulkUpdateEntity();
        entity.setItemBulkUpdateId(model.getUpdateId());
        entity.setUpdateType(model.getUpdateType());
        entity.setItemBulkUpdateJson(model);
        entity.setCreatedBy(model.getUpdateOwner());
        entity.setUpdatedBy(systemUsername());

        ItemBulkUpdateEntity persistedEntity = entityMgr.save(entity);
        log.info("Item bulk update record inserted {} ", persistedEntity.getId());

        return persistedEntity;
    }

    private String systemUsername() {
        return itemBankProperties.getSystemUser().getUserName();
    }
}
