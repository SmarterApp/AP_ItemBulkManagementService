package org.opentestsystem.ap.ibms;

import lombok.extern.slf4j.Slf4j;
import org.apache.commons.collections4.CollectionUtils;
import org.apache.commons.collections4.ListUtils;
import org.apache.commons.lang3.StringUtils;
import org.opentestsystem.ap.common.bulkupdate.ItemBulkUpdateCheckedException;
import org.opentestsystem.ap.common.bulkupdate.ItemBulkUpdateEventProducer;
import org.opentestsystem.ap.common.bulkupdate.ItemBulkUpdateFactory;
import org.opentestsystem.ap.common.bulkupdate.ItemBulkUpdateFileManager;
import org.opentestsystem.ap.common.bulkupdate.ItemBulkUpdateItemManager;
import org.opentestsystem.ap.common.bulkupdate.ItemBulkUpdateUtility;
import org.opentestsystem.ap.common.bulkupdate.model.ItemBulkUpdate;
import org.opentestsystem.ap.common.config.ItemBankProperties;
import org.opentestsystem.ap.common.datastore.entity.ItemBulkUpdateEntity;
import org.opentestsystem.ap.common.datastore.repository.ItemBulkUpdateEntityRepository;
import org.opentestsystem.ap.common.datastore.repository.SequenceRepository;
import org.opentestsystem.ap.common.exception.ValidationException;
import org.opentestsystem.ap.common.util.SecurityUtil;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.web.multipart.MultipartFile;

import java.sql.Date;
import java.time.Instant;
import java.util.List;
import java.util.Objects;
import java.util.stream.Collectors;

import static org.opentestsystem.ap.common.bulkupdate.ItemBulkUpdateConstants.IBU_STATUS_PENDING;
import static org.opentestsystem.ap.common.bulkupdate.ItemBulkUpdateConstants.IBU_STATUS_RECEIVED;

@Slf4j
@Service
public class ItemBulkUpdateService {

    private final ItemBankProperties itemBankProperties;

    private final SequenceRepository seqMgr;

    private final SecurityUtil securityUtil;

    private final ItemBulkUpdateEntityRepository entityMgr;

    private final ItemBulkUpdateFactory factory;

    private final ItemBulkUpdateFileManager fileMgr;

    private final ItemBulkUpdateItemManager itemManager;

    private final ItemBulkUpdateUtility utility;

    private final ItemBulkUpdateEventProducer eventProducer;

    public ItemBulkUpdateService(ItemBankProperties itemBankProperties,
                                 SequenceRepository seqMgr,
                                 SecurityUtil securityUtil,
                                 ItemBulkUpdateEntityRepository entityMgr,
                                 ItemBulkUpdateFactory factory,
                                 ItemBulkUpdateFileManager fileMgr,
                                 ItemBulkUpdateItemManager itemManager,
                                 ItemBulkUpdateUtility utility,
                                 ItemBulkUpdateEventProducer eventProducer) {
        this.itemBankProperties = itemBankProperties;
        this.seqMgr = seqMgr;
        this.securityUtil = securityUtil;
        this.entityMgr = entityMgr;
        this.factory = factory;
        this.fileMgr = fileMgr;
        this.itemManager = itemManager;
        this.utility = utility;
        this.eventProducer = eventProducer;
    }

    @Transactional
    public ItemBulkUpdate processUpdateRequest(ItemBulkUpdateRequest request) {
        log.info("processing bulk update request");

        ItemBulkUpdate ibu = this.processReceived(request, securityUtil.getUsername());

        log.info("the request contains file {}", ibu.getUploadFileName());
        this.fileMgr.uploadItemBulkUpdateFile(ibu.getUpdateId(), request.getFile());

        ItemBulkUpdate ibuClone = this.processPending(ibu);

        return ibuClone;
    }

    @Transactional
    public ItemBulkAssignmentResponse addItemAssignees(ItemBulkAssignmentRequest request)
        throws ItemBulkUpdateCheckedException {
        log.info("processing bulk assignment request");

        validateBulkAssignmentRequest(request);

        ItemBulkAssignmentResponse assignmentResponse = new ItemBulkAssignmentResponse();
        this.itemManager.addAssignees(securityUtil.getItemBankUser(), request.getItemIds(), request.getUserNames());
        assignmentResponse.setStatus("SUCCESS");

        return assignmentResponse;
    }

    @Transactional
    public ItemBulkAssignmentResponse removeItemAssignees(ItemBulkAssignmentRequest request)
        throws ItemBulkUpdateCheckedException {
        log.info("processing bulk unassignment request");

        validateBulkAssignmentRequest(request);

        ItemBulkAssignmentResponse assignmentResponse = new ItemBulkAssignmentResponse();
        this.itemManager.removeAssignees(securityUtil.getItemBankUser(), request.getItemIds(), request.getUserNames());
        assignmentResponse.setStatus("SUCCESS");

        return assignmentResponse;
    }

    @Transactional
    public ItemBulkAssignmentResponse removeAllItemAssignees(ItemBulkAssignmentRequest request)
        throws ItemBulkUpdateCheckedException {
        log.info("processing bulk unassignment request");

        validateBulkRemovalRequest(request);

        ItemBulkAssignmentResponse assignmentResponse = new ItemBulkAssignmentResponse();
        this.itemManager.removeAllAssignees(securityUtil.getItemBankUser(), request.getItemIds());
        assignmentResponse.setStatus("SUCCESS");

        return assignmentResponse;
    }

    @Transactional(readOnly = true)
    public List<ItemBulkUpdate> findUserUpdates(String updateType) {
        log.debug("find updates of type {} for {}", updateType, securityUtil.getUsername());
        List<ItemBulkUpdateEntity> entities = ListUtils
            .emptyIfNull(this.entityMgr.findByUser(updateType, securityUtil.getUsername()));
        return entities.stream().map(ItemBulkUpdateEntity::getItemBulkUpdateJson).collect(Collectors.toList());
    }

    @Transactional(readOnly = true)
    public ItemBulkUpdate findLatest(String updateId) {
        log.debug("find latest item bulk update record for update {}, requesting user {}",
            updateId, securityUtil.getUsername());
        ItemBulkUpdateEntity entity = this.entityMgr.findLatest(updateId);
        return Objects.nonNull(entity) ? entity.getItemBulkUpdateJson() : null;
    }

    @Transactional
    public ItemBulkResponse updateItemWorkflowStatus(ItemBulkWorkflowStatusRequest request) {
        log.info("processing bulk item update workflow status request");

        validateWorkflowStatusRequest(request);

        if (StringUtils.isBlank(request.getMessage())) {
            request.setMessage(String.format("Updated status to '%s'", request.getWorkflowStatusCode()));
        }

        this.itemManager.updateWorkflowStatus(
            securityUtil.getItemBankUser(),
            request.getWorkflowStatusCode(),
            request.isOverride(),
            request.getItemIds(),
            request.getMessage());

        return new ItemBulkResponse("SUCCESS");
    }


    @Transactional
    public ItemBulkResponse updateItemAccessibility(ItemBulkAccessibilityRequest request) {
        log.info("processing bulk item update workflow status request");

        String type = request.getPropertyType();

        Object value;
        if ("boolean".equalsIgnoreCase(type)) {
            value = Boolean.valueOf(request.getPropertyValue());
        } else{
            value = request.getPropertyValue();
        }

        this.itemManager.patchItems(
            securityUtil.getItemBankUser(),
            request.getItemIds(),
            request.getSection(),
            request.getPropertyPath(),
            value,
            request.getMessage()
        );
        return new ItemBulkResponse("SUCCESS");
    }


        // ------------------------------------------------------------------------

    private ItemBulkUpdate processReceived(ItemBulkUpdateRequest request, String startedBy) {
        log.info("processReceived");
        String updateId = seqMgr.nextItemBulkUpdateSequence().toString();

        String updateType = request.getUpdateType();
        MultipartFile file = request.getFile();

        ItemBulkUpdate ibu = factory.newModel(updateId, updateType);
        ibu.timestamp();

        ibu.setUpdateMessage("Storing zip file");
        ibu.setUpdateStatus(IBU_STATUS_RECEIVED);
        ibu.setUpdateOwner(startedBy);
        ibu.setUpdateStartDate(Date.from(Instant.now()));

        ibu.setUploadFileName(file.getOriginalFilename());
        ibu.setUploadFileSize(String.valueOf(file.getSize()));

        this.save(ibu);

        return ibu;
    }

    private ItemBulkUpdate processPending(ItemBulkUpdate ibu) {
        log.info("processPending");

        ItemBulkUpdate ibuClone = this.utility.cloneModel(ibu);
        ibuClone.timestamp();
        ibuClone.setUpdateMessage("Pending");
        ibuClone.setUpdateStatus(IBU_STATUS_PENDING);
        ibuClone.setUploadCompleteDate(Date.from(Instant.now()));
        ibuClone.setUploadDuration(Long.toString(
            ibuClone.getUploadCompleteDate().getTime() - ibuClone.getUpdateStartDate().getTime()));

        ItemBulkUpdateEntity entity = this.save(ibuClone);

        this.eventProducer.sendPendingRequestEvent(entity);

        return ibuClone;
    }

    private ItemBulkUpdateEntity save(ItemBulkUpdate model) {
        ItemBulkUpdateEntity entity = new ItemBulkUpdateEntity();
        entity.setItemBulkUpdateId(model.getUpdateId());
        entity.setUpdateType(model.getUpdateType());
        entity.setItemBulkUpdateJson(model);
        entity.setCreatedBy(model.getUpdateOwner());
        entity.setUpdatedBy(systemUsername());

        ItemBulkUpdateEntity persistedEntity = entityMgr.save(entity);
        log.info("Item bulk update record inserted {} ", persistedEntity.getId());

        return persistedEntity;
    }

    private String systemUsername() {
        return itemBankProperties.getSystemUser().getUserName();
    }


    private void validateBulkAssignmentRequest(ItemBulkAssignmentRequest request) throws ItemBulkUpdateCheckedException {
        if (request.getItemIds().size() == 0) {
            throw new ItemBulkUpdateCheckedException("Request contains no item ids");
        }
        if (request.getUserNames().size() == 0) {
            throw new ItemBulkUpdateCheckedException("Request contains no user names");
        }
    }

    private void validateBulkRemovalRequest(ItemBulkAssignmentRequest request) throws ItemBulkUpdateCheckedException {
        if (request.getItemIds().size() == 0) {
            throw new ItemBulkUpdateCheckedException("Request contains no item ids");
        }
    }

    private void validateWorkflowStatusRequest(ItemBulkWorkflowStatusRequest request) {
        if (CollectionUtils.isEmpty(request.getItemIds())) {
            throw new ValidationException("Request contains no item ids");
        }
        if (StringUtils.isBlank(request.getWorkflowStatusCode())) {
            throw new ValidationException("Request contains no workflow status");
        }
        if (StringUtils.isBlank(request.getMessage())) {
            throw new ValidationException("Request must contain a comment");
        }
    }

}
