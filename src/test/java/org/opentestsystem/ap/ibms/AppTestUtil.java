/*
 *  Copyright 2017 Regents of the University of California.
 *
 *  Licensed under the Educational Community License, Version 2.0 (the "license");
 *  you may not use this file except in compliance with the License. You may
 *  obtain a copy of the license at
 *
 *  https://opensource.org/licenses/ECL-2.0
 *
 *  Unless required by applicable law or agreed to in writing, software
 *  distributed under the License is distributed on an "AS IS" BASIS,
 *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  See the License for the specific language governing permissions and
 *  limitations under the License.
 */
package org.opentestsystem.ap.ibms;

import freemarker.template.Configuration;
import freemarker.template.TemplateExceptionHandler;
import lombok.Getter;
import lombok.extern.slf4j.Slf4j;
import org.opentestsystem.ap.common.assembler.AppAssembler;
import org.opentestsystem.ap.common.assembler.StringAssembler;
import org.opentestsystem.ap.common.config.ItemBankProperties;
import org.opentestsystem.ap.common.model.ItemBankUser;
import org.opentestsystem.ap.common.model.ItemConstants;
import org.opentestsystem.ap.common.model.ItemContext;
import org.opentestsystem.ap.common.model.ItemFactory;
import org.opentestsystem.ap.common.model.ItemTransaction;
import org.opentestsystem.ap.common.saaif.JsonModelAssembler;
import org.opentestsystem.ap.common.saaif.SaaifAssembler;
import org.opentestsystem.ap.common.saaif.SaaifMetadataAssembler;
import org.opentestsystem.ap.common.saaif.SaaifWordListAssembler;
import org.opentestsystem.ap.common.saaif.ValidationResultAssembler;
import org.opentestsystem.ap.common.saaif.transformer.TransformerFactory;

import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;

import static org.opentestsystem.ap.common.model.ItemConstants.Section.SECTION_CORE;

/**
 * When instantiated the utility creates a temp directory and another directory in it. These represent the local repo
 * base and a local repository.  There is a cleanup method intended for tests during tear down.
 */
@Slf4j
@Getter
public class AppTestUtil {

    private ItemFactory itemFactory = new ItemFactory();

    private TransformerFactory transformerFactory = new TransformerFactory();

    // ------------------------------------------------------------------------

    public static final String SECTION = ItemConstants.Section.SECTION_CORE;

    public static final ItemBankUser ITEM_BANK_USER = new ItemBankUser("hal_jordan@fairwaytech.com", "Hal Jordan");

    public static final ItemBankUser ITEM_BANK_USER2 = new ItemBankUser("clark_kent@fairwaytech.com", "Clark Kent");

    public static final Integer GROUP_ID = 8765309;

    public static final Integer PROJECT_ID = 11;

    public static final String BANK_KEY = "200";

    public static final String ITEM_ID = "200000";

    public static final String LEGACY_ID = String.format("item-%s-%s", BANK_KEY, ITEM_ID);

    public static final String FIELD_PATH = "core.en.prompt";

    public static final String TRANSACTION_ID = "testTransactionId";

    public static final ItemTransaction ITEM_AUTHOR = new ItemTransaction(ITEM_BANK_USER.getUserName(), SECTION_CORE);

    public static final String HISTORY_ID = "testHistoryId";

    public static final String ITEM_BANK_HOST = "http://itembank.com";

    public static final String API_VERSION = "/api/version";


    public static final String COMMIT_MESSAGE = "this is a commit message";

    public static final String PROMPT = "This is a prompt";

    public static final String PROMPT_RICH_TEXT = "<p style=\"font-weight: bold;\">This is a rich text prompt</p>";

    public static final String EXEMPLAR_RESPONSE_1 = "This is an exemplar response 1";

    public static final String EXEMPLAR_RESPONSE_2 = "This is an exemplar response 2";

    public static final String WORKFLOW_STATUS_DRAFT = "Draft";

    public static final String SYSTEM_VERSION = "iat-42";


    // ------------------------------------------------------------------------

    private ItemBankProperties gitlabProperties;

    private Path localBaseDir;

    private Path localRepoDir;

    private String gitlabHost = "https://gitlab-dev.smarterbalanced.org";

    private String gitlabUser = "test@fake.com";

    private String gitlabPass = "testPassword";

    private String gitlabGroup = "TestItembankGroup";

    private String gitLabProject = ITEM_ID;

    private int idMinValue = 1000000000;

    private int idMaxValue = Integer.MAX_VALUE;

    private Configuration freemarker;

    private SaaifAssembler saaifAssembler;

    private SaaifMetadataAssembler metadataAssembler;

    private SaaifWordListAssembler wordListAssembler;

    private JsonModelAssembler jsonModelAssembler;

    private ValidationResultAssembler validationResultAssembler;

    private AppAssembler assembler;

    private StringAssembler stringAssembler;

    private ItemContext itemContext;

    /**
     * Creates a temporary directory using a prefix of <code>gitlabGroup</code>. A directory is created in the temp
     * directory with the name <code>gitLabProject</code>. The <code>GitlabProperties</code> instance is created with
     * the default values set on the class's instance properties.
     */
    public AppTestUtil() {
        init();
    }

    /**
     * Same as the default constructor but instead of using default values the class's instance properties are first set
     * with the arguments of the constructor.
     */
    public AppTestUtil(String gitlabHost, String gitlabUser, String gitlabPass, String gitlabGroup,
                       String gitLabProject, int idMinValue, int idMaxValue) {
        this.gitlabHost = gitlabHost;
        this.gitlabUser = gitlabUser;
        this.gitlabPass = gitlabPass;
        this.gitlabGroup = gitlabGroup;
        this.gitLabProject = gitLabProject;
        this.idMinValue = idMinValue;
        this.idMaxValue = idMaxValue;

        init();
    }

    private void init() {
        try {
            localBaseDir = Files.createTempDirectory(gitlabGroup);
            localRepoDir = Files.createDirectories(Paths.get(localBaseDir.toString(), ITEM_BANK_USER.parseUsername(),
                gitLabProject));
        } catch (IOException e) {
            throw new RuntimeException(e);
        }

        gitlabProperties = new ItemBankProperties();
        gitlabProperties.setGroup(gitlabGroup);
        gitlabProperties.setHost(gitlabHost);
        gitlabProperties.setIdMinValue(idMinValue);
        gitlabProperties.setIdMaxValue(idMinValue);
        gitlabProperties.setUser(gitlabUser);
        gitlabProperties.setPassword(gitlabUser);
        gitlabProperties.setLocalBaseDir(localBaseDir.toString());
        gitlabProperties.setSystemVersion(SYSTEM_VERSION);

        freemarker = new Configuration(Configuration.VERSION_2_3_25);
        freemarker.setClassForTemplateLoading(this.getClass(), "/saaif_templates");
        freemarker.setTemplateExceptionHandler(TemplateExceptionHandler.RETHROW_HANDLER);
        freemarker.setDefaultEncoding("UTF-8");

        stringAssembler = new StringAssembler(freemarker);

        metadataAssembler = new SaaifMetadataAssembler();
        metadataAssembler.init();

        wordListAssembler = new SaaifWordListAssembler();
        wordListAssembler.init();

        saaifAssembler = new SaaifAssembler(metadataAssembler, wordListAssembler);
        saaifAssembler.init();

        jsonModelAssembler = new JsonModelAssembler();

        validationResultAssembler = new ValidationResultAssembler();

        assembler = new AppAssembler(saaifAssembler,jsonModelAssembler, validationResultAssembler, stringAssembler);

        itemContext = new ItemContext(ITEM_ID, LEGACY_ID, BANK_KEY, assembler, localRepoDir);
    }
}
